<!-- employee-form.component.html -->
<app-modal
  modalId="employee-create-form"
  [title]="employeeToUpdate ? 'Edit Employee' : 'Create a new Employee'"
  (close)="closePopup()"
  width="90%">

  <!-- Steps Progress Bar -->
  <div class="box lg:border-b lg:border-t lg:border-gray-200 mb-4"  *ngIf="!employeeToUpdate">
    <nav class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8" aria-label="Progress">
      <ol
        role="list"
        class="overflow-hidden rounded-md lg:flex lg:rounded-none lg:border-l lg:border-r lg:border-gray-200">
        <li class="relative overflow-hidden lg:flex-1" *ngFor="let step of steps">
          <div class="overflow-hidden border border-gray-200 lg:border-0">
            <a aria-current="step">
              <span
                class="absolute left-0 top-0 h-full w-1 lg:bottom-0 lg:top-auto lg:h-1 lg:w-full"
                [ngClass]="step.position === currentStep() ? 'bg-indigo-600' : 'bg-gray-200'"
                aria-hidden="true"></span>
              <span class="flex items-start px-6 py-5 text-sm font-medium lg:pl-9">
                <span class="shrink-0">
                  <span
                    class="flex size-10 items-center justify-center rounded-full border-2"
                    [ngClass]="step.position === currentStep() ? 'border-indigo-600' : 'border-gray-300'">
                    <span
                      [ngClass]="step.position === currentStep() ? 'text-indigo-600' : 'text-gray-500'">
                      0{{ step.position + 1 }}
                    </span>
                  </span>
                </span>
                <span class="ml-4 mt-0.5 flex min-w-0 flex-col">
                  <span
                    class="text-sm font-medium"
                    [ngClass]="step.position === currentStep() ? 'text-indigo-600' : 'text-gray-500'">
                    {{ step.subtitle }}
                  </span>
                </span>
              </span>
            </a>
          </div>
        </li>
      </ol>
    </nav>
  </div>

  <form [formGroup]="employeeForm" class="mx-auto w-full">
    <!-- Step 0: Personal Information -->
    <div *ngIf="currentStep() === 0 || employeeToUpdate" class="grid grid-cols-12 gap-4 p-4">
      <div class="col-span-12">
        <h3 class="text-lg font-semibold mb-3">Personal Information</h3>
      </div>

      <div class="col-span-6">
        <app-form-input
          [form]="employeeForm"
          controlName="name"
          inputId="name"
          label="Name "
          placeholder="Enter  name"
          [required]="true"
          [submitted]="isSubmitted">
        </app-form-input>
      </div>

      <div class="col-span-6">
        <app-form-input
          [form]="employeeForm"
          controlName="description"
          inputId="description"
          label="SurName"
          [required]="true"
          placeholder="Enter SurName"
          [submitted]="isSubmitted">
        </app-form-input>
      </div>

      <div class="col-span-6">
        <app-form-input
          [form]="employeeForm"
          controlName="cni"
          inputId="cni"
          label="CNI Number"
          placeholder="Enter CNI number"
          [required]="true"
          [submitted]="isSubmitted">
        </app-form-input>
      </div>

      <div class="col-span-6">
        <app-form-select
          [form]="employeeForm"
          controlName="sexId"
          label="Gender"
          [options]="sexes"
          optionLabel="sexLabel"
          optionValue="sexID"
          [required]="true"
          [submitted]="isSubmitted">
        </app-form-select>
      </div>

      <div class="col-span-6">
        <app-form-input
          [form]="employeeForm"
          controlName="birthDate"
          inputId="birthDate"
          label="Birth Date"
          inputType="date"
          [required]="true"
          [submitted]="isSubmitted">
        </app-form-input>
      </div>

      <div class="col-span-6">
        <app-form-select
          [form]="employeeForm"
          controlName="maritalStatus"
          label="Marital Status"
          [options]="maritalStatuses"
          optionLabel="label"
          optionValue="value"
          [submitted]="isSubmitted">
        </app-form-select>
      </div>

      <div class="col-span-6">
        <app-form-input
          [form]="employeeForm"
          controlName="childrenCount"
          inputId="childrenCount"
          label="Number of Children"
          inputType="number"
          placeholder="0"
          [submitted]="isSubmitted">
        </app-form-input>
      </div>
    </div>

    <!-- Step 1: Employment Information -->
    <div *ngIf="currentStep() === 1 || employeeToUpdate" class="grid grid-cols-12 gap-4 p-4">
      <div class="col-span-12">
        <h3 class="text-lg font-semibold mb-3">Employment Information</h3>
      </div>

      <div class="col-span-6">
        <app-form-input
          [form]="employeeForm"
          controlName="hireDate"
          inputId="hireDate"
          label="Hire Date"
          inputType="date"
          [required]="true"
          [submitted]="isSubmitted">
        </app-form-input>
      </div>

      <div class="col-span-6">
        <app-form-input
          [form]="employeeForm"
          controlName="cnpsNumber"
          inputId="cnpsNumber"
          label="CNPS Number"
          placeholder="Enter CNPS number"
          [submitted]="isSubmitted">
        </app-form-input>
      </div>

      <div class="col-span-6">
        <app-form-select
          [form]="employeeForm"
          controlName="branchId"
          label="Branch"
          [options]="branches"
          optionLabel="branchName"
          optionValue="branchID"
          [required]="true"
          [submitted]="isSubmitted">
        </app-form-select>
      </div>

      <div class="col-span-6">
        <app-form-select
          [form]="employeeForm"
          controlName="departmentId"
          label="Department"
          [options]="departments"
          optionLabel="departmentName"
          optionValue="departmentID"
          [required]="true"
          [submitted]="isSubmitted">
        </app-form-select>
      </div>

      <div class="col-span-6">
        <app-form-select
          [form]="employeeForm"
          controlName="jobId"
          label="Job"
          [options]="jobs"
          optionLabel="jobLabel"
          optionValue="jobID"
          [required]="true"
          [submitted]="isSubmitted">
        </app-form-select>
      </div>

      <div class="col-span-6">
        <app-form-select
          [form]="employeeForm"
          controlName="studyFieldId"
          label="Study field"
          [options]="studyFields"
          optionLabel="fieldName"
          optionValue="studyFieldID"
          [required]="true"
          [submitted]="isSubmitted">
        </app-form-select>
      </div>

      <div class="col-span-6">
        <app-form-select
          [form]="employeeForm"
          controlName="degreeId"
          label="Degree"
          [options]="degrees"
          optionLabel="degreeName"
          optionValue="degreeID"
          [required]="true"
          [submitted]="isSubmitted">
        </app-form-select>
      </div>
    </div>

    <!-- Step 2: Address Information -->
    <div *ngIf="currentStep() === 2 || employeeToUpdate" class="grid grid-cols-12 gap-4 p-4">
      <div class="col-span-12">
        <h3 class="text-lg font-semibold mb-3">Address Information</h3>
      </div>

      <div class="col-span-12" formGroupName="adress">
        <div class="grid grid-cols-12 gap-4">
          <div class="col-span-6">
            <app-form-input
              [form]="$any(employeeForm.get('adress'))"
              controlName="adressPhoneNumber"
              inputId="adressPhoneNumber"
              label="Phone Number"
              placeholder="Phone Number"
              [required]="true"
              [submitted]="isSubmitted">
            </app-form-input>
          </div>

          <div class="col-span-6">
            <app-form-input
              [form]="$any(employeeForm.get('adress'))"
              controlName="adressCellNumber"
              inputId="adressCellNumber"
              label="Cell Number"
              placeholder="Cell Number"
              [submitted]="isSubmitted">
            </app-form-input>
          </div>

          <div class="col-span-6">
            <app-form-input
              [form]="$any(employeeForm.get('adress'))"
              controlName="adressEmail"
              inputId="adressEmail"
              label="Email"
              placeholder="Email Address"
              inputType="email"
              [required]="true"
              [submitted]="isSubmitted">
            </app-form-input>
          </div>

          <div class="col-span-6">
            <app-form-input
              [form]="$any(employeeForm.get('adress'))"
              controlName="adressPOBox"
              inputId="adressPOBox"
              label="PO Box"
              placeholder="PO Box"
              [submitted]="isSubmitted">
            </app-form-input>
          </div>

          <div class="col-span-6">
            <app-form-select
              [form]="$any(employeeForm.get('adress'))"
              controlName="countryID"
              inputId="countryID"
              label="Country (*)"
              placeholder="Select a country"
              [options]="countries"
              optionLabel="countryLabel"
              optionValue="countryID"
              [required]="true"
              [submitted]="isSubmitted">
            </app-form-select>
          </div>

          <div class="col-span-6">
            <app-form-select
              [form]="$any(employeeForm.get('adress'))"
              controlName="regionID"
              inputId="regionID"
              label="Region (*)"
              placeholder="Select a region"
              [options]="regions"
              optionLabel="regionLabel"
              optionValue="regionID"
              [required]="true"
              [submitted]="isSubmitted">
            </app-form-select>
          </div>

          <div class="col-span-6">
            <app-form-select
              [form]="$any(employeeForm.get('adress'))"
              controlName="townID"
              inputId="townID"
              label="Town (*)"
              placeholder="Select a town"
              [options]="towns"
              optionLabel="townLabel"
              optionValue="townID"
              [required]="true"
              [submitted]="isSubmitted">
            </app-form-select>
          </div>

          <div class="col-span-6">
            <app-form-select
              [form]="$any(employeeForm.get('adress'))"
              controlName="quarterID"
              inputId="quarterID"
              label="Quarter (*)"
              placeholder="Select a quarter"
              [options]="quarters"
              optionLabel="quarterLabel"
              optionValue="quarterID"
              [required]="true"
              [submitted]="isSubmitted">
            </app-form-select>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 3: Contract (Optional) -->
    <div *ngIf="currentStep() === 3 && !employeeToUpdate" class="grid grid-cols-12 gap-4 p-4">
      <div class="col-span-12">
        <h3 class="text-lg font-semibold mb-3">Contract Information (Optional)</h3>
        <p class="text-sm text-gray-600 mb-4">
          Would you like to create a contract for this employee now? You can skip this step and create it later.
        </p>
      </div>

      <div class="col-span-12 mb-4">
        <label class="flex items-center cursor-pointer">
          <input
            type="checkbox"
            [checked]="wantsToCreateContract()"
            (change)="wantsToCreateContract.set($any($event.target).checked)"
            class="form-checkbox h-5 w-5 text-indigo-600">
          <span class="ml-2 text-gray-700">Yes, I want to create a contract now</span>
        </label>
      </div>

      <div *ngIf="wantsToCreateContract()" class="col-span-12" formGroupName="contract">
        <div class="grid grid-cols-12 gap-4">
          <!-- Contract Basic Info -->
          <div class="col-span-12">
            <h4 class="text-md font-semibold mb-3">Contract Details</h4>
          </div>

          <div class="col-span-4">
            <app-form-select
              [form]="$any(employeeForm.get('contract'))"
              controlName="contractTypeId"
              label="Contract Type"
              [options]="contractTypes"
              optionLabel="contractTypeName"
              optionValue="contractTypeID"
              [required]="true"
              [submitted]="isSubmitted">
            </app-form-select>
          </div>

          <div class="col-span-4">
            <app-form-input
              [form]="$any(employeeForm.get('contract'))"
              controlName="contractReference"
              inputId="contractReference"
              label="Contract Reference"
              placeholder="Enter contract reference"
              [submitted]="isSubmitted">
            </app-form-input>
          </div>

          <div class="col-span-4">
            <app-form-input
              [form]="$any(employeeForm.get('contract'))"
              controlName="startDate"
              inputId="startDate"
              label="Start Date"
              inputType="date"
              [required]="true"
              [submitted]="isSubmitted">
            </app-form-input>
          </div>

          <div class="col-span-4">
            <app-form-input
              [form]="$any(employeeForm.get('contract'))"
              controlName="endDate"
              inputId="endDate"
              label="End Date (Optional)"
              inputType="date"
              [submitted]="isSubmitted">
            </app-form-input>
          </div>

          <div class="col-span-4">
            <app-form-input
              [form]="$any(employeeForm.get('contract'))"
              controlName="probationPeriodMonths"
              inputId="probationPeriodMonths"
              label="Probation Period (Months)"
              inputType="number"
              placeholder="0"
              [submitted]="isSubmitted">
            </app-form-input>
          </div>

          <div class="col-span-12">
            <app-form-input
              [form]="$any(employeeForm.get('contract'))"
              controlName="terms"
              inputId="terms"
              label="Terms & Conditions"
              placeholder="Enter contract terms"
              inputType="textarea"
              [submitted]="isSubmitted">
            </app-form-input>
          </div>

          <!-- Salary Information -->
          <div class="col-span-12 mt-4" formGroupName="initialSalary">
            <h4 class="text-md font-semibold mb-3">Initial Salary</h4>

            <div class="grid grid-cols-12 gap-4">

              <div class="col-span-4">
                <app-form-input
                  [form]="$any(employeeForm.get('contract.initialSalary'))"
                  controlName="effectiveDate"
                  inputId="effectiveDate"
                  label="Effective Date"
                  inputType="date"
                  [required]="true"
                  [submitted]="isSubmitted">
                </app-form-input>
              </div>

              <div class="col-span-4">
                <app-form-input
                  [form]="$any(employeeForm.get('contract.initialSalary'))"
                  controlName="baseSalary"
                  inputId="baseSalary"
                  label="Base Salary"
                  inputType="number"
                  placeholder="0"
                  [required]="true"
                  [submitted]="isSubmitted">
                </app-form-input>
              </div>

              <div class="col-span-4">
                <app-form-input
                  [form]="$any(employeeForm.get('contract.initialSalary'))"
                  controlName="transportAllowance"
                  inputId="transportAllowance"
                  label="Transport Allowance"
                  inputType="number"
                  placeholder="0"
                  [submitted]="isSubmitted">
                </app-form-input>
              </div>

              <div class="col-span-4">
                <app-form-input
                  [form]="$any(employeeForm.get('contract.initialSalary'))"
                  controlName="housingAllowance"
                  inputId="housingAllowance"
                  label="Housing Allowance"
                  inputType="number"
                  placeholder="0"
                  [submitted]="isSubmitted">
                </app-form-input>
              </div>

              <div class="col-span-4">
                <app-form-input
                  [form]="$any(employeeForm.get('contract.initialSalary'))"
                  controlName="riskAllowance"
                  inputId="riskAllowance"
                  label="Risk Allowance"
                  inputType="number"
                  placeholder="0"
                  [submitted]="isSubmitted">
                </app-form-input>
              </div>

               <div class="col-span-4">
                <app-form-input
                  [form]="$any(employeeForm.get('contract.initialSalary'))"
                  controlName="overtimeAllowance"
                  inputId="overtimeAllowance"
                  label="overtime Allowance"
                  inputType="number"
                  placeholder="0"
                  [submitted]="isSubmitted">
                </app-form-input>
              </div>



              <div class="col-span-4">
                <app-form-input
                  [form]="$any(employeeForm.get('contract.initialSalary'))"
                  controlName="dutyAllowance"
                  inputId="dutyAllowance"
                  label="Duty Allowance"
                  inputType="number"
                  placeholder="0"
                  [submitted]="isSubmitted">
                </app-form-input>
              </div>

              <div class="col-span-4">
                <app-form-input
                  [form]="$any(employeeForm.get('contract.initialSalary'))"
                  controlName="otherAllowances"
                  inputId="otherAllowances"
                  label="other Allowance"
                  inputType="number"
                  placeholder="0"
                  [submitted]="isSubmitted">
                </app-form-input>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>

  <!-- Footer Buttons -->
  <div footer>
    <div class="flex justify-between w-full">
      <button
        *ngIf="currentStep() > 0 && !employeeToUpdate"
        type="button"
        (click)="prevStep()"
        class="ti-btn ti-border font-medium bg-white text-gray-700 shadow-sm">
        Previous
      </button>
      <div></div>
      <div class="flex gap-2">
        <button
          type="button"
          (click)="closePopup()"
          class="ti-btn ti-border font-medium bg-white text-gray-700 shadow-sm">
          {{ currentStep() === 3 && !employeeToUpdate ? 'Skip Contract' : 'Close' }}
        </button>
        <button
          *ngIf="currentStep() < 3 || employeeToUpdate"
          class="ti-btn ti-btn-primary"
          type="button"
          (click)="employeeToUpdate ? updateEmployee() : nextStep()">
          {{ employeeToUpdate ? 'Save changes' : currentStep() === 2 ? 'Create Employee' : 'Next' }}
        </button>
        <button
          *ngIf="currentStep() === 3 && !employeeToUpdate"
          class="ti-btn ti-btn-primary"
          type="button"
          (click)="nextStep()">
          {{ wantsToCreateContract() ? 'Create Contract & Finish' : 'Finish' }}
        </button>
      </div>
    </div>
  </div>
</app-modal>
