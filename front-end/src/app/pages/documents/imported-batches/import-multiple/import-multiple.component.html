<!-- Main Modal -->
<div *ngIf="open" class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
  <div class="bg-white shadow-xl rounded-lg w-[850px] max-h-[90vh] overflow-hidden">

    <!-- HEADER -->
    <div class="p-4 border-b flex justify-between items-center">
      <h2 class="font-bold text-lg">Import Multiple PDF Files</h2>
      <button class="text-xl font-bold" (click)="closeModal()" [disabled]="uploading">×</button>
    </div>

    <!-- BODY -->
    <div class="p-4 space-y-3 overflow-y-auto max-h-[70vh]">

      <input type="file" multiple accept=".pdf"
             (change)="onFilesSelected($event)"
             class="ti-form-input border rounded p-2 w-full" />

      <!-- Summary counters -->
      <div *ngIf="files?.length" class="text-sm font-medium text-gray-700">
        {{ duplicateCount }} duplicate(s) skipped –
        {{ validCount }} ready to import
      </div>

      <div class="space-y-3">
        <div *ngFor="let f of files"
             class="border rounded p-2"
             [ngClass]="{
               'bg-red-50 border-red-300': f.blocked,
               'bg-gray-50': !f.blocked
             }">

          <!-- Filename -->
          <div class="flex justify-between text-sm font-semibold">
            <span class="truncate w-2/3">{{ f.file.name }}</span>
            <span class="text-xs">{{ f.file.size / 1024 | number:'1.0-0' }} KB</span>
          </div>

          <!-- STATUS LABEL -->
          <div class="text-xs mt-1"
               [ngClass]="{
                 'text-yellow-600': f.blocked,
                 'text-red-600': !f.decoded.year,
                 'text-green-700': !f.blocked && f.decoded.year
               }">

            <ng-container *ngIf="f.blocked">
              ⚠ Already imported – will be skipped
            </ng-container>

            <ng-container *ngIf="!f.blocked && !f.decoded.year">
              ❌ Invalid filename format
            </ng-container>

            <ng-container *ngIf="!f.blocked && f.decoded.year">
              ✔ {{ f.decoded.year }} | {{ f.decoded.examCode }} | {{ f.decoded.center }} | batch {{ f.decoded.batch }}
            </ng-container>
          </div>

          <!-- PROGRESS BAR -->
          <div *ngIf="f.status !== 'waiting'" class="mt-2">
            <div class="w-full bg-gray-200 h-2 rounded overflow-hidden">
              <div class="bg-primary h-2 rounded" [style.width.%]="f.progress"></div>
            </div>
            <p class="text-[11px] mt-1"
               [ngClass]="{
                 'text-green-700': f.status === 'done',
                 'text-yellow-600': f.status === 'duplicate',
                 'text-red-600': f.status === 'failed'
               }">
              {{ f.status }} {{ f.progress }}%
            </p>
          </div>

        </div>
      </div>

    </div>

    <!-- FOOTER -->
    <div class="p-3 border-t flex justify-between items-center">
      <button class="ti-btn ti-btn-light" (click)="closeModal()" [disabled]="uploading">
        Close
      </button>

      <button class="ti-btn ti-btn-primary"
              (click)="uploadAll()"
              [disabled]="!canUpload">
        {{ uploading ? 'Uploading...' : 'Upload All' }}
      </button>
    </div>

  </div>
</div>
